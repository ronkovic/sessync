# Lefthook - Git Hooks Manager
# https://github.com/evilmartians/lefthook

# pre-commit: コミット時のチェック（高速）
pre-commit:
  parallel: true
  commands:
    fmt-check:
      run: cargo fmt --all -- --check
      fail_text: "フォーマットエラー。'cargo fmt --all' を実行してください。"
    clippy:
      run: cargo clippy --all-targets --all-features -- -D warnings
      fail_text: "Clippy警告があります。修正してからコミットしてください。"

# pre-push: プッシュ時のチェック（テスト含む）
pre-push:
  parallel: false
  commands:
    fmt-check:
      run: cargo fmt --all -- --check
      fail_text: "フォーマットエラー。'cargo fmt --all' を実行してください。"
    clippy:
      run: cargo clippy --all-targets --all-features -- -D warnings
      fail_text: "Clippy警告があります。修正してからプッシュしてください。"
    test:
      run: cargo nextest run --all-features --workspace
      fail_text: "テストが失敗しました。修正してからプッシュしてください。"
    coverage:
      run: |
        THRESHOLD=${COVERAGE_THRESHOLD:-$(cat .coverage-threshold 2>/dev/null || echo 80)}
        echo "Coverage threshold: ${THRESHOLD}%"
        cargo +nightly llvm-cov nextest --all-features --workspace --fail-under-lines $THRESHOLD
      fail_text: "カバレッジが閾値未満です（閾値は .coverage-threshold で設定）。テストを追加してください。"
      env:
        RUSTFLAGS: "--cfg coverage_nightly"
